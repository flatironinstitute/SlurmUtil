<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/static/css/normalize.css" />
    <link rel="stylesheet" href="/static/css/style2.css" />
    <title>Tabular Summary</title>

    <script type="text/javascript" src="static/scripts/jquery.min.js"></script>
    <script type="text/javascript" src="static/scripts/d3.v5.min.js"></script>
    <script type="text/javascript" src="static/scripts/myFunc.js"></script>
    <script type="text/javascript" src="static/scripts/myTable.js"></script>
    <script type="text/javascript" src="static/scripts/myList.js"></script>
    <script type="text/javascript">
      const INTERVAL_REFRESH_SEC=600
      function timedRefresh(timeoutPeriod) {{
         setTimeout("location.reload(true);",timeoutPeriod);  // no need to use setInterval
      }}
      window.onload = timedRefresh(INTERVAL_REFRESH_SEC * 1000);

      $(document).ready(function(){{
         //add menu
          $("#navmenu").load("/getHeader?page=index");
          $("#crumbmenu").load("/getBreadcrumbs?path=index");

          const displayName = {{'node':'Node', 'status':'Status', 'delay':'Delay', 'job':'Job',  'user':'User', 'alloc_cpus':'Alloc CPUs', 'proc_count':'Proc', 'cpu_util':'CPU Util', 'avg_cpu_util':'Avg CPU Util', 'rss':'RSS', 'vms':'VMS', 'io':'I/O Bps', 'fds':'Num Fds', 'alloc_gpus':'Alloc GPUs', 'gpu_util':'GPU Util', 'avg_gpu_util':'Avg GPU Util', 'run_time':'Run Time'}}
          const displayType = {{'node':'Node', 'delay':'Float', 'job':'JobAndStep', 'user':'User', 'alloc_cpus':'Int', 'proc_count':'Int', 'cpu_util':'Float', 'avg_cpu_util':'Float', 'rss':'Byte','vms':'Byte','io':'BigInt', 'fds':'Int', 'alloc_gpus':'Int', 'gpu_util':'Float', 'avg_gpu_util':'Float', 'run_time':'Int'}}     //default is string
          const summaryType = {{'delay':'avg', 'alloc_cpus':'total', 'proc_count':'total', 'cpu_util':'avg', 'avg_cpu_util':'avg', 'rss':'avg','vms':'avg','io':'avg','fds':'total', 'alloc_gpus':'total', 'gpu_util':'avg', 'avg_gpu_util':'avg', 'run_time':'avg'}}  //default is count

          var data        = {table_data}
          var display_fld = {column}
          var alarm_lst   = {alarms}  //0: low_util, inform; 1: high_util, alarm
          var user        = {user}
          const display_title = Object.keys(displayName)
                                  .filter(function(key) {{return display_fld.includes(key);}})
                                  .reduce(function(obj, key) {{
                                      obj[key] = displayName[key];
                                      return obj;
                                  }}, {{}});
          if (user) {{
             console.log("user=",user)
             $("#user").append(', <a href="./userDetails?user=' + user + '">User ' + user + " Detail</a>")
          }}
          createSummaryTable (data, display_title, 'summary_table',  'summary', displayType, summaryType, alarm_lst);
      }});
    </script>
  </head>

  <body>
    <div class="layout">
      <div class="crumb__container">
        <div class="crumb__inner">
          <div class="crumb__content">
            <div class="crumb__logo">
              <a href="/" class="hero__title hero__title--crumb">Slurm Util</a>
              <span>Updated: {update_time}</span>
            </div>
            <div class="crumbs" id="crumbmenu"></div>
          </div>
        </div>
      </div>
      <nav class="nav" id="navmenu"></nav>
      <section class="section">
        <div class="section__inner section__inner--fullwidth">
          <div class="section__div">
            <h3>
              Cluster Nodes & Jobs (<small><a href="./clusterHistory?days=7">Cluster History</a></small
              ><small id="user"></small>)
            </h3>
          </div>
          <div class="section__div" id="summary"></div>
        </div>
      </section>
    </div>
    <footer class="section section--footer">
      <div class="section__inner section__inner--footer">
        <a href="/" class="hero__title hero__title--footer">Slurm Util</a>
        <p class="hero__text hero__text--small">Automatically updated every 10 minutes</p>
        <p class="hero__text hero__text--small" id="signature"></p>
      </div>
    </footer>
  </body>
  <script>
    const now = new Date();
    const year = now.getFullYear();
    const signature = 'Flatiron Institute, ' + year;
    const sig = document.querySelector(`#signature`);
    sig.innerHTML = signature;
  </script>
</html>
