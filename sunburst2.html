<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/static/css/normalize.css" />
    <link rel="stylesheet" href="/static/css/style2.css" />
    <title>Sunburst Graph</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.5.0/d3.min.js"></script>
    <!-- Todo: Move this CSS -->
    <!-- <style>
      path {
        stroke: #fff;
        fill-rule: evenodd;
      }

      text {
        font-family: Arial, sans-serif;
        font-size: 8px;
      }

      div.tooltip {
        position: absolute;
        text-align: center;
        width: 200px;
        height: 100px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }
    </style> -->
  </head>
  <body>
    <div class="layout">
      <div class="stickynav">
        <div class="stickynav__inner">
          <div class="stickynav__content">
            <div class="stickynav__logo">
              <a href="/" class="hero__title hero__title--crumb">Slurm Util</a>
            </div>
            <div class="stickynav__update">Updated: {update_time}</div>
          </div>
        </div>
      </div>
      <nav class="nav" id="navmenu"></nav>
      <section class="section">
        <div class="section__inner">
          <div class="section__div">
            <div id="optionsSelect">
              <h3>Sunburst Graph</h3>
              <div>
                <label for="optionsList">Select a Graph Option 1:</label>
                <select id="optionsList">
                  <option value="load_data">Load Graph</option>
                  <option value="vms_data">VMS Graph</option>
                  <option value="rss_data">RSS Graph</option>
                  <option value="state_data">State Graph</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="section">
        <div class="section__inner">
          <div class="section__div section__div--sunburst">
            <div class="flex flex__center" id="sunburst"></div>
          </div>
        </div>
      </section>
    </div>
    <footer class="section section--footer">
      <div class="section__inner section__inner--footer">
        <a href="/" class="hero__title hero__title--footer">Slurm Util</a>
        <p class="hero__text hero__text--small">Updates every 10 minutes</p>
      </div>
    </footer>
    <script type="text/javascript">
      $(document).ready(() => {
        $('#navmenu').load('/getHeader?page=sunburst');
        var thisPath = window.location.pathname;
        $('#crumbmenu').load('/getBreadcrumbs?path=' + thisPath);
      });
    </script>
    <script type="text/javascript">
      var users = %(users)s
      var load_data = %(data1)s
      var vms_data = %(data3)s
      var rss_data = %(data4)s
      var state_data = %(data2)s

      function getColor(name) {
        var rgb;
        switch(name) {
          case 'cca':
            rgb = 'rgb(206, 50,50)';
            break;
          case 'ccb':
            rgb = 'rgb(129, 173, 74)';
            break;
          case 'ccm':
            rgb = 'rgb(246, 134, 45)';
            break;
          case 'ccn':
            rgb = 'rgb(0, 128, 158)';
            break;
          case 'ccq':
            rgb = 'rgb(132, 91, 142)';
            break;
          case 'scc':
            rgb = 'rgb(143, 143, 143)';
            break;
          case 'ib':
            rgb = 'rgb(255, 194, 0)';
            break;
          default:
            rgb = 'rgb(83, 146, 195)';
        }
        return rgb;
      }

      function createVisualization(data) {
        var arc = d3.arc()
          .startAngle(d => d.x0)
          .endAngle(d => d.x1)
          .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
          .padRadius(radius * 1.5)
          .innerRadius(d => d.y0 * radius)
          .outerRadius(d => Math.max(d.y0 * radius, d.y1 * radius - 1));
        var width = 932;
        var radius = width / 6;
        var format = d3.format(",d");

        function partition(data) {
          var groot = d3.hierarchy(data)
              .sum(d => d.value)
              .sort((a, b) => b.value - a.value);
          return d3.partition()
              .size([2 * Math.PI, groot.height + 1])
            (groot);
        }

        var root = partition(data);
        root.each(d => d.current = d);

        var svg = d3.select("#sunburst")
          .append("svg:svg")
          .attr("viewBox", [0, 0, width, width])
          .style("font", "11px sans-serif");

        var g = svg.append("g")
          .attr("transform", `translate(${width / 2},${width / 2})`);

        var path = g.append("g")
          .selectAll("path")
          .data(root.descendants().slice(1))
          .join("path")
          .attr("fill", d => {
            while (d.depth > 1) d = d.parent;
            return getColor(d.data.name);
          })
          .attr("fill-opacity", d => arcVisible(d.current) ? (d.children ? 0.6 : 0.4) : 0)
          .attr("d", d => arc(d.current));

        path.filter(d => d.children)
          .style("cursor", "pointer")
          .on("click", clicked);

        path.append("title")
          .text(d => `${d.ancestors().map(d => d.data.name).reverse().join("/")}\n${format(d.value)}`);

        var label = g.append("g")
          .attr("pointer-events", "none")
          .attr("text-anchor", "middle")
          .style("user-select", "none")
          .selectAll("text")
          .data(root.descendants().slice(1))
          .join("text")
          .attr("dy", "0.35em")
          .attr("fill-opacity", d => +labelVisible(d.current))
          .attr("transform", d => labelTransform(d.current))
          .text(d => d.data.name);

        var parent = g.append("circle")
          .datum(root)
          .attr("r", radius)
          .attr("fill", "none")
          .attr("pointer-events", "all")
          .on("click", clicked);

        function clicked(event, p) {
          parent.datum(p.parent || root);

          root.each(d => d.target = {
            x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
            x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
            y0: Math.max(0, d.y0 - p.depth),
            y1: Math.max(0, d.y1 - p.depth)
          });

          var t = g.transition().duration(750);

          // Transition the data on all arcs, even the ones that arenâ€™t visible,
          // so that if this transition is interrupted, entering arcs will start
          // the next transition from the desired position.
          path.transition(t)
            .tween("data", d => {
              var i = d3.interpolate(d.current, d.target);
              return t => d.current = i(t);
            })
            .filter(function(d) {
              return +this.getAttribute("fill-opacity") || arcVisible(d.target);
            })
            .attr("fill-opacity", d => arcVisible(d.target) ? (d.children ? 0.6 : 0.4) : 0)
            .attrTween("d", d => () => arc(d.current));

          label.filter(function(d) {
              return +this.getAttribute("fill-opacity") || labelVisible(d.target);
            }).transition(t)
            .attr("fill-opacity", d => +labelVisible(d.target))
            .attrTween("transform", d => () => labelTransform(d.current));
        }

        function arcVisible(d) {
          return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0;
        }

        function labelVisible(d) {
          return d.y1 <= 3 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.03;
        }

        function labelTransform(d) {
          const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
          const y = (d.y0 + d.y1) / 2 * radius;
          return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
        }

        return svg.node();
      } // End createVisualization

      var sunburst = createVisualization(load_data);
      d3.select('#optionsList')
        .on('change', function() {
          var newData = eval(d3.select(this).property('value'));
          var newBurst = createVisualization(newData);
          d3.select("#sunburst").remove();
          d3.select("#sunburst").append(newBurst);
        });
    </script>
  </body>
</html>
