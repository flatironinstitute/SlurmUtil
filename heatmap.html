<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <title>Host Utilization Heatmap</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="http://rawgithub.com/indrimuska/jquery-editable-select/master/dist/jquery-editable-select.min.css" rel="stylesheet">
    <script src="http://d3js.org/d3.v3.js"></script>
    <script type="text/javascript" src="static/scripts/jquery.min.js"></script>
    <script type="text/javascript" src="static/scripts/myHeatmap.js"></script>
    <script src="http://rawgithub.com/indrimuska/jquery-editable-select/master/dist/jquery-editable-select.min.js"></script>
    <script>
       $(function(){
          $("#tabmenu").load("/getHeader?page=utilHeatmap")
       });
    </script>
  </head>
  <body>
    <div class="tab" id="tabmenu"></div>
    <div id="header">
       <h3>Worker Nodes Utilization</h3>
       <i>Update time: %(update_time)s</i>
       <p> <i>"Click" to see the co-allocated worker nodes for the same job. "Double Click" to see the worker node details.</i>
       <hr></div>
    <div id="select_div">Select an option to see the allocated worker nodes: 
       <select id="select_job_user">
          <option value="job"> Job </option>
          <option value="user">User</option>
       </select></div>
    <div id="select_list_div"></div>
    <div id="legend"> 
       <input type="checkbox" id="colorCheckbox" name="colorCheckBox" checked> 
       <label for="color"> Color to differentiate account </label>
       <p><svg id="legend_svg"></svg></div>
    <div><svg id="node_svg"></svg></div>
    <div>
       <h3>GPU Utilization</h3>
       <i id='gpu_update'></i>
       <p> <i>"Click" to see the co-allocated worker nodes for the same job. "Double Click" to see the worker node details.</i>
       <hr></div>
    <div><svg id="gpu_svg"> </svg></div>

    <script type="text/javascript">
      var margin      = { top: 10, right: 0, bottom: 50, left: 120 },
          gpu_margin  = { top: 100, right: 0, bottom: 50, left: 120 },
          width       = 960  - margin.left - margin.right,
          height      = 900  - margin.top - margin.bottom,
          cntPerLine  = 32,                                         //count per line
          acctColor   = true,                                       //wether use color for each account
          gridSize    = Math.floor(width / cntPerLine),
          workers     = %(data1)s                                   //input
          jobs_data   = %(data2)s                                   //input
          users_data  = %(users)s                                   //input
          gpu_obj     = %(gpu)s

      console.log("workers=", workers, "jobs=", jobs_data, "users=", users_data, "orig gpu=", gpu_obj)
      var labels       = [], gpu_labels=[];                   // labels, save results 
      var grpCnt       = [0,0,0,0,0,0,0,0,0];  // count for each group worker0..., ..., save results from function call
      var workers_data = prepareNodeData (workers, grpCnt, labels, gpu_obj)
      var gpu_data     = prepareGPUData  (workers_data,    gpu_labels)
      var gpu_gridSize = Math.floor(width / gpu_labels.length)
      console.log("workers_data=",workers_data, "gpu_data=",gpu_data);

      var gpu_update = new Date(gpu_obj["time"]*1000)
      d3.select("#gpu_update").text("Update time: " + gpu_update.toString());

      var legend_svg = d3.select("#legend_svg")
          .attr("width",  width + margin.left + margin.right)
          .attr("height", 100)
          .append("g")
             .attr("transform", "translate(" + 120 + "," + 10 + ")");
      
      var svg_line = 0
      for (var i=0; i<grpCnt.length; i++)
          svg_line += Math.ceil(grpCnt[i] / cntPerLine)
      var svg     = createSVG    ("#node_svg", ".label",        labels, width+margin.left+margin.right, svg_line*gridSize +margin.top+margin.bottom, margin, gridSize)
      var gpu_svg = createGPUSVG ("#gpu_svg",  ".gpuNodeLabel", ".gpuLabel", gpu_labels, width+margin.left+margin.right, 4*gridSize+margin.top+margin.bottom+100, gpu_margin, gpu_gridSize)

      // add heatmap labels under svg
      var heatmapChart = function(data) {
          createLegend    (legend_svg, acctColor, gridSize);
          createHeatMap   (svg,     data,     acctColor, grpCnt, cntPerLine, gridSize)
          createGPUHeatMap(gpu_svg, gpu_data, acctColor, grpCnt, cntPerLine, gpu_gridSize)
      };

      function job_onchange() {
         selectedJid=d3.select("#select_list_div select").property("value");
         $(".bordered").removeClass("popout");
         $(`.${selectedJid}`).addClass("popout");
      }
      function user_onchange() {
         sel_jids=d3.select("#select_list_div select").property("value");
         jids    =sel_jids.split(',')
         console.log("user_onchange " + jids)
         $(".bordered").removeClass("popout");
         jids.forEach(function(e) {
            console.log(e)
            $(`.${e}`).addClass("popout");
         });
      }
      
      d3.select("#select_job_user")
        .on('change', function() {
           val = d3.select(this).property('value');
           if (val == 'job') {
              createSelectList ("#select_list_div", jobs_data,  "#select_list",  "job_id", job_onchange);
           } else {
              createSelectList ("#select_list_div", users_data, "#select_list",  "jobs",   user_onchange);
           }
         });
      d3.select("#colorCheckbox")
        .on('change', function () {
           //console.log(d3.event)
           acctColor = d3.event.target.checked
           console.log("onchange of colorCheckbox set acctColor=" + acctColor)

           d3.selectAll(".node").remove()
           d3.selectAll(".legend").remove()
           heatmapChart(workers_data)
         })
      createSelectList ("#select_list_div", jobs_data,  "#select_list",  "job_id", job_onchange);
      heatmapChart     (workers_data);
      
    </script>
  </body>
</html>
