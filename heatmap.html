<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <link rel="stylesheet" href="/static/css/style.css">

    <style>
      rect.bordered {
        stroke: #E6E6E6;
        stroke-width:2px;   
      }
      rect.popout{
        stroke: black;
        stroke-width:4px;   
        z-index: 999 
      }

      text.mono {
        font-size: 9pt;
        font-family: Consolas, courier;
        fill: #aaa;
      }

      text.axis-workweek {
        fill: #000;
      }

      text.axis-worktime {
        fill: #000;
      }
    </style>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="http://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="http://rawgithub.com/indrimuska/jquery-editable-select/master/dist/jquery-editable-select.min.js"></script>
<link href="http://rawgithub.com/indrimuska/jquery-editable-select/master/dist/jquery-editable-select.min.css" rel="stylesheet">

    <script>
       $(function(){
          $("#tabmenu").load("/getHeader?page=utilHeatmap")
       });</script>
  </head>
  <body>
    <div class="tab" id="tabmenu"></div>

    <div>
    <h3>Worker Nodes Utilization</h3>
    <i>Update time: %(update_time)s</i>
    <p> <i>"Click" to see the co-allocated worker nodes for the same job. "Double Click" to see the worker node details.</i>
    <p> Choose a job to see the allocated worker nodes: <select id="jobs"></select>
    </div>
    
    <div id="legend"> 
       <input type="checkbox" id="colorCheckbox" name="colorCheckBox" checked> 
       <label for="color"> Color to differentiate account </label>
       <p> <svg></svg> </div>
    <div id="chart">  <svg></svg> </div>

    <script type="text/javascript">
      var margin   = { top: 10, right: 0, bottom: 100, left: 120 },
          width    = 960  - margin.left - margin.right,
          height   = 900  - margin.top - margin.bottom,
          cntLine  = 32,
          buckets  = 10,
          colors   = ["#0d0dff", "#0d97ff", "#0dffff", "#0dff87","0dff0d","87ff0d", "ffff0d", "#ff870d","#ff5b5b", "red"], 
          acctColor   = true,
          accts       = ['cca', 'ccb', 'ccm', 'ccq', 'etc'],
          redColor    = ["#ffeaea","#ffd0d0","#ffb6b6","#ff9c9c","#ff8282","#ff6868","#ff4e4e","#ff2727","#f30000","#cf0000"], 
          purpleColor = ["#f5eaff","#e8d0ff","#dbb6ff","#cf9cff","#c282ff","#b568ff","#a84eff","#9527ff","#7a00f3","#6200cf"], 
          greenColor  = ["#eaffea","#d0ffd0","#b6ffb6","#9cff9c","#82ff82","#68ff68","#4eff4e","#27ff27","#00f300","#00cf00"],
          orangeColor = ["#fff5ea","#ffe8d0","#ffdbb6","#ffcf9c","#ffbb75","#ffa84e","#ff9527","#f37a00","#cf6800","#ab5600"],
          blueColor   = ["#eaf5ff","#d0e8ff","#b6dbff","#9ccfff","#82c2ff","#68b5ff","#4ea8ff","#2795ff","#007af3","#0068cf"],
          acctColors  = {'cca': redColor, 'ccb': greenColor, 'ccm': orangeColor, 'ccq': purpleColor, 'etc': blueColor},
          gridSize = Math.floor(width / cntLine),
          dataset1 = %(data1)s
          dataset2 = %(data2)s

      console.log(dataset1)
      console.log(dataset2)
      var labels   = [];             // labels
      var grpCnt   = [0,0,0,0,0,0];  // count for each group worker0..., ...
      var iData  = prepareData (dataset1, grpCnt, labels)
      console.log(iData);
      console.log(labels);
      console.log(grpCnt);

      var svgL = d3.select("#legend").select("svg")
          .attr("width",  width + margin.left + margin.right)
          .attr("height", 100)
          .append("g")
             .attr("transform", "translate(" + 120 + "," + 10 + ")");

      var svg = d3.select("#chart").select("svg")
          .attr("width",  width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
             .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      var nodeLabels = svg.selectAll (".nodeLabel")
          .data (labels)
          .enter().append("text")
             .text(function (d) {return d+",...";})
             .attr("x", 0)
             .attr("y", function (d, i) { return (i)*gridSize;})
            .style("text-anchor", "end")
             .attr("transform", "translate(-6," + gridSize / 1.5 + ")");

      var heatmapChart = function(data) {
          var colorScale = d3.scale.quantize()
              .domain([0, buckets - 1, 1])
              .range(colors);
          
          var colorScales = {}
          for (var acct of accts) {
              colorScales[acct] = d3.scale.quantize()
                 .domain([0, buckets - 1, 1])
                 .range(acctColors[acct]);
          }

          var cards = svg.selectAll(".node")
              .data(data);
          cards.enter().append("rect")
              .attr("x", function(d, i) { var x = d["gIdx"] - Math.floor(d["gIdx"]/cntLine) * cntLine; return x * gridSize; })
              .attr("y", function(d, i) { 
                            var y=0,i; 
                            for (i=0; i<d["gID"]; i++) 
                                y += Math.ceil(grpCnt[i]/cntLine); 
                            return (y + Math.floor(d["gIdx"]/cntLine) )* gridSize; })
              .attr("rx", 4)
              .attr("ry", 4)
              .attr("class", function(d) { 
                                var str="bordered"; 
                                d["jobs"].forEach(function(e) {str += " " + e}); 
                                return str;})
              .attr("width",  gridSize)
              .attr("height", gridSize)
              .attr("title", function (d) {return d["name"]})
              .attr("value", function (d) {return d["util"]})
              .on("dblclick", function(d) {
                              if (d3,event.ctrlKey) {
                                 location.href="jobDetails?jobid="+d["jobs"]
                              } else {
                                 location.href="nodeDetails?node="+d["name"]
                              }})
              .on("click", function(d) {
                              var keyArr=d["jobs"]; 
                              keyArr.forEach(function(e) {
                                               $(".bordered").removeClass("popout");
                                               $(`.${e}`).addClass("popout")})})
              .style("fill",  "gray");
          cards.transition().duration(1000)
              .style("fill", function(d) { var currColorS = colorScale
                                           if (acctColor ) {
                                              if ( d["acct"].length == 1 && d["acct"][0] in colorScales)
                                                 currColorS  = colorScales[d["acct"][0]]
                                              else
                                                 currColorS  = colorScales["etc"]
                                           }
                                           if (d["stat"]==0) return "gray"; 
                                           else if (d["stat"]==-1) return "black";
                                           else return currColorS(d["util"]); });
          cards.append("title");
          cards.select("title").text(function(d) {return d["labl"]});
          cards.exit().remove();

          var y=0
          var legend = svgL.selectAll(".legend")
                 .data([-0.2,-0.1,0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9]);
          if (acctColor) {
            for (var acct of accts) {
             
             legend.enter().append("g")
                 .attr("class", "legend");
             legend.append("rect")
               .attr("x", function(d, i) { return gridSize * 2 * i; })
               .attr("y", y)
               .attr("width",  gridSize * 2)
               .attr("height", gridSize / 2)
               .style("fill",  function(d, i) { if (i==0) return "black"; 
                                                else if (i==1) return "gray";
                                                else return acctColors[acct][i-2]; });
          
             
             y = y + gridSize/2
             legend.append("text")
               .attr("class", "mono")
               .text(acct)
               .attr("x", -gridSize)
               .attr("y", y);
             }
           } else {
             legend.enter().append("g")
                 .attr("class", "legend");
             legend.append("rect")
               .attr("x", function(d, i) { return gridSize * 2 * i; })
               .attr("y", y)
               .attr("width",  gridSize * 2)
               .attr("height", gridSize / 2)
               .style("fill",  function(d, i) { if (i==0) return "black"; 
                                                else if (i==1) return "gray";
                                                else return colors[i-2]; });
          
             
             y = y + gridSize/2
           }

           legend.append("text")
               .attr("class", "mono")
               .text(function(d, i) { if (i==0) return "Down"; 
                                      else if (i==1) return "Idle";
                                      else if (i==2) return "Alloc"; 
                                      else return "â‰¥ " + d; })
               .attr("x", function(d, i) { return gridSize * 2 * i; })
               .attr("y", y+gridSize/2);
           legend.exit().remove();
      };

      var selectChart =function (data){
          var jobsSel = d3.select("#jobs")
                          .on('change', onchange)
                          .on('select.editable-select', function(e) {console.log(e)});
          jobsSel.selectAll("option")
                 .data(data)
                 .enter().append("option")
                 .text(function(d) { return d["long_label"]})
                 .attr("value",    function(d) {return d["job_id"]})
                 .attr("disabled", function(d) {if (d["disabled"]) return d["disabled"]; else return undefined});
      };
      function onchange() {
         selectedJid=d3.select("#jobs").property("value");
         $(".bordered").removeClass("popout");
         $(`.${selectedJid}`).addClass("popout");
      }
 
      heatmapChart(iData);
      selectChart (dataset2);
      //$('#jobs').editableSelect();
      
      d3.select("#colorCheckbox")
        .on('change', function () {
           //console.log(d3.event)
           acctColor = d3.event.target.checked
           console.log("onchange of colorCheckbox set acctColor=" + acctColor)

           d3.selectAll(".node").remove()
           d3.selectAll(".legend").remove()
           heatmapChart(iData)
         })

      function prepareData (nodeData, grpCnt, labels) {
        var objData  = [];             // data that will be used later

        //nodeData is already sorted by group 
        for (var i=0; i<nodeData.length; i++) {
          var obj = {name: nodeData[i][0], stat: nodeData[i][1], core: nodeData[i][2], 
                     jobs: nodeData[i][4], acct: nodeData[i][5], labl: nodeData[i][6]};
          if ( obj.stat == 1)
             obj.util=nodeData[i][3]/obj.core;
          else
             obj.util=0
          
          switch (nodeData[i][0].slice(6,7)) {
                 case "0": obj.gID = 0; break; // worker0...
                 case "1": obj.gID = 1; break; // worker1...
                 case "2": obj.gID = 2; break; // worker2...
                 case "3": obj.gID = 3; break; // worker3...
                 case "g": obj.gID = 4; break; // workergpu..
                 case "m": obj.gID = 5; break; // workermem..
                 case "p": obj.gID = 6; break; // workerphi..
          }
          obj.gIdx        = grpCnt[obj.gID];
          if ( Math.floor(grpCnt[obj.gID] / cntLine)*cntLine == grpCnt[obj.gID] )
             labels.push(obj.name);
          grpCnt[obj.gID] ++;
   
          objData.push (obj);
        }

        return objData
      }
    </script>
  </body>
</html>
