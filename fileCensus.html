<!DOCTYPE HTML>
<html>
    <head>
        <link rel="stylesheet" href="/static/css/style.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>File Count and Bytes</title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="http://www.d3plus.org/js/d3.js"></script>
	<!--<script type="text/javascript" src="static/scripts/jquery-2.1.3.min.js"></script>-->
	<script type="text/javascript" src="static/scripts/highcharts.js"></script>
	<script type="text/javascript" src="static/scripts/highcharts-more.js"></script>
	<script type="text/javascript" src="static/scripts/exporting.js"></script>

	<style type="text/css">
	 .highcharts-tooltip h3 {
	     margin: 0.3em 0;
	 }
	</style>

	<script type="text/javascript">
	 var chart;
         var data        = %(data)s
         console.log (data)
	 $(function () {
             $("#tabmenu").load("/getHeader?page=usageGraph")
             fillOptions (%(file_systems)s)
             displayData (data['home'])
         })

         function displayData (fs_data) {
             console.log("displayData", fs_data[1])
	     var titleString = fs_data[0] + ': File Count and Bytes of Users on ' + fs_data[2];
	     chart = Highcharts.chart('container', {
		 bubble: {
		     minSize: 3,
		     maxSize: 10,
		 },
		 chart: {
		     panKey: 'shift',
		     panning: true,
		     plotBorderWidth: 1,
		     type: 'bubble',
		     zoomType: 'xy'
		 },
		 credits: {
		     enabled: false,
		 },
		 legend: {
		     enabled: false,
		 },
		 title: {
		     text: titleString,
		 },
		 xAxis: {
		     type: 'logarithmic',
		     gridLineWidth: 1,
		     title: {
			 text: 'Total bytes'
		     },
		 },
		 yAxis: {
		     type: 'logarithmic',
		     startOnTick: false,
		     endOnTick: false,
		     title: {
			 text: 'File count'
		     },
		     maxPadding: 0.2,
		 },
		 tooltip: {
		     useHTML: true,
		     headerFormat: '<table>',
		     pointFormatter: function(){ return '<tr><th colspan="2"><h3>' + this.name + '</h3></th></tr>' +
							'<tr><th>Bytes:</th><td>' + this.x.toExponential(3) + '</td></tr>' +
							'<tr><th>Files:</th><td>' + this.y.toExponential(3) + '</td></tr>' +
							'<tr><th>Delta bytes:</th><td>' + this.dfb.toExponential(3) + '</td></tr>' +
							'<tr><th>Delta files:</th><td>' + this.dfc + '</td></tr>' } ,
		     footerFormat: '</table>',
		     followPointer: true
		 },
		 plotOptions: {
		     series: {
			 dataLabels: {
			     enabled: true,
			     format: '{point.name}'
			 },
                         events: {
                           click: function(event) {
                              console.log("click username=", event.point.name)
                              location.replace("./user_fileReport?user="+event.point.name)
                           },
                         }
		     },
		 },
		 series: [{
		     data: fs_data[1]
		 }]

	     });
	     // Clone the highchart font family setting from the title element to use with the input label element.
	     hcff = $("tspan:contains('"+titleString+"')").css('font-family');
	     $('#usernameLabel').css('font-family', hcff);

             
	 }
	 function selectUser() {
	     var username = $('input[id=username]').val();
	     for (d of chart.series[0].data) {
		 if (username == d.name) {
		     chart.xAxis[0].setExtremes(d.x/4, d.x*4);
		     chart.yAxis[0].setExtremes(d.y/4, d.y*4);
		     chart.showResetZoom();
		     return false;
		 }
	     }
	     alert('Did not find user: '+ username);
	     return false
	 }

         // file_systems is dict of value:[description,...] 
         function fillOptions (fs) {
            console.log (fs)
            d3.select("#fsList").selectAll("option")
              .data(Object.keys(fs))
              .enter()
              .append("option")
              .attr("value", function (d) {return d})
              .text(function (d) {return fs[d][0]})

            $("#fsList").val("home");
            $("#fsList").change(function() {
               var val=$("#fsList option:selected").attr("value");
               displayData(data[val])
               console.log("Changed to ", val)
            })
         }
	</script>
    </head>
    <body>
        <div class="tab" id="tabmenu"></div>
        <p>
        <div id="fsSelect"><label>Select a File System:</label>
            <select id="fsList">
            </select>
            <br/>
        </div>
	<div id="userSelect">
	    <form action="javascript:selectUser()">
		<label id="usernameLabel" for="username">Center on User:&nbsp;</label><input type="text" id="username">
	    </form>
	</div>

	<div id="container" style="height: 640px; min-width: 620px; max-width: 1200px; margin: 0 auto">	</div>
        <div>
        Note: Double-Click on a user to see the history (default to 180 days) of the user's file usage.
        </div>
    </body>
</html>
