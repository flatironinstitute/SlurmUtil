<!DOCTYPE html>
<html>

<head>
<meta charset='UTF-8'>
<title>Pending Jobs</title>
<link rel="stylesheet" href="/static/css/style.css">

<script src="http://code.jquery.com/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script>
   $(function(){{
      $("#tabmenu").load("/getHeader?page=pending")
   }});
</script>

<!--[if !IE]><!-->
<style>
    * {{ 
        margin: 0; 
	padding: 0; 
    }}
    body {{ 
        font: 14px/1.4 Georgia, Serif; 
    }}
    .page-wrap {{
        margin: 40px;
    }}
    p {{
        margin: 20px 0; 
    }}
</style>
<!--<![endif]-->
</head>

<body>
<div class="tab" id="tabmenu"></div>

<div id="pending_jobs" class="page-wrap">
<h1>Pending Jobs</h1>
Update time: {update_time}
<!--<p>Click the table header to sort data according to that column</p>
-->
</div>
<div id="partitions" class="page-wrap">
<h1>Partitions</h1>
</div>

<script type="text/javascript">
    var j_titles     = {{'job_id':'Job', 'submit_time_str':'Submit Time', 'num_nodes':'Req Node', 'num_cpus':'Req CPU', 'user':'User', 'account':'Account', 'partition':'Req Part.', 'state_reason':'Pending Reason', 'state_exp':'Note'}}
    var p_titles     = {{'name':'Name', 'flag_shared':'Share', 'total_nodes':'Total Node', 'total_cpus':'Total CPU', 'avail_nodes':'Avail Node', 'avail_cpus':'Avail CPU','pending_jobs':'PENDING JOB', 'running_jobs':'RUNNING JOB'}}
    displayData ({pending_jobs_input}, j_titles, '#pending_jobs');
    displayData ({partitions_input},   p_titles, '#partitions');

    function displayData (data, titles_dict, div_id) {{
	var sortAscending = true;
	var table         = d3.select(div_id).append('table');
        var firstKey      = Object.keys(titles_dict)[0]   <!--use jobid as tie breaker for sorting -->
	//var titles        = d3.keys(data[0]);

        console.log(data)
	var headers = table.append('thead')
                           .append('tr')
		           .selectAll('th')
		           .data(Object.keys(titles_dict)).enter()
		           .append('th')
		           .text(function (d) {{ return titles_dict[d]; }})
		           .on('click', function (d) {{
                               console.log ('on click ' + d)
		               headers.attr('class', 'header');
		                	   
		               if (sortAscending) {{
		                  rows.sort(function(a, b) {{
                                      console.log('cmp ' + d + ' value ' + JSON.stringify(b[d]) + '<' + JSON.stringify(a[d])); 
                                      if (a[d] == b[d]) {{console.log('ret ' + (b[firstKey]<a[firstKey])); return b[firstKey]<a[firstKey];}} 
                                      else {{console.log('ret ' + (b[d]<a[d])); return b[d] < a[d];}} }});
		                  sortAscending  = false;
		                  this.className = 'aes';
		               }} else {{
		                  rows.sort(function(a, b) {{ if (b[d] == a[d]) {{return b[firstKey]>a[firstKey];}} else {{return b[d] > a[d];}} }});
		                  sortAscending  = true;
		                  this.className = 'des';
		               }}
		                	   
		            }});
		  
	var rows = table.append('tbody').selectAll('tr')
		               .data(data).enter()
		               .append('tr');
	rows.selectAll('td')
	    .data(function (d) {{
		return Object.keys(titles_dict).map(function (k) {{
		    return {{ 'value': d[k], 'name': k}};
		}});
	    }}).enter()
	    .append('td')
	    .attr('data-th', function (d) {{
		    	return d.name;
	    }})
	    .html(function (d) {{
                 if (d.name == 'user') {{
                    return '<a href=./userJobs?user=' + d.value+'>' + d.value + '</a>'
                 }} else if (d.name == 'partition') {{
                    return '<a href=./partitionDetail?partition=' + d.value+'>' + d.value + '</a>'
                 }}
                
		 return d.value;
	    }});
    }};
</script>
</body>

</html>
