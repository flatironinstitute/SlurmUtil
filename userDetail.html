<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/static/css/normalize.css" />
    <link rel="stylesheet" href="/static/css/style2.css" />

    <title>User Detail</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="static/scripts/jquery.min.js"></script>
    <script type="text/javascript" src="static/scripts/myFunc.js"></script>
    <script type="text/javascript" src="static/scripts/myTable.js"></script>
    <script type="text/javascript" src="static/scripts/myList.js"></script>
    <script type="text/javascript">

      $(document).ready(function(){{
          // Add menus
          $("#navmenu").load("/getHeader?page=index");
          var thisPath = window.location.pathname;
          $('#crumbmenu').load('/getBreadcrumbs?path=' + thisPath);

          //create table job_table and part_table
          var r_j_titles     = {{'job_id':'Job ID', 'partition':'Partition', 'name':'Job Name', 'submit_time':'Submit Time', 'start_time':'Start Time', 'nodes':'Nodes', 'tres_req_str':'Tres Req', 'tres_alloc_str':'Tres Alloc', 'command':'Command', 'work_dir':'Work Dir'}}
          var p_j_titles     = {{'job_id':'Job ID', 'partition':'Partition', 'name':'Job Name', 'submit_time':'Submit Time', 'tres_req_str':'Tres Req', 'state_reason':'Pending Reason', 'state_exp':'Note'}}
          var part_titles    = {{'name': 'Part.', 'flag_shared':'Sharable',
                                 'user_lmt_nodes'  :'Node', 'user_lmt_cpus'  :'CPU', 'user_lmt_gpus'  :'GPU',
                                 'user_alloc_nodes':'Node', 'user_alloc_cpus':'CPU', 'user_alloc_gpus':'GPU',
                                 'user_avail_nodes':'Node', 'user_avail_cpus':'CPU', 'user_avail_gpus': 'GPU',
                                 'grp_lmt_nodes'   :'Node', 'grp_lmt_cpus'   :'CPU', 'grp_lmt_gpus'   :'GPU',
                                 'grp_alloc_nodes' :'Node', 'grp_alloc_cpus' :'CPU', 'grp_alloc_gpus' :'GPU',
                                 'total_nodes'     :'Node', 'total_cpus'     :'CPU', 'total_gpus'     :'GPU',
                                 'avail_nodes_cnt' :'Node', 'avail_cpus_cnt' :'CPU', 'avail_gpus_cnt' :'GPU',
                               }}
          var j_h_titles     = {{'JobID':'Job ID', 'JobName':'Name','AllocCPUS':'Alloc CPU','State':'State','ExitCode':'Exit Code','NodeList':'Alloc Node','Start':'Start','End':'End'}}
          var part_type_dict = {{'name':'Partition'}}
          var job_type_dict  = {{'JobName':'JobName', 'name':'JobName', 'submit_time':'Time','start_time':'Time', 'tres_req_str':'TresShort', 'tres_alloc_str':'TresShort'}}
          var jr_type_dict   = {{'JobID':'JobAndStep', 'JobIDRaw':'JobAndStep'}}
          var u_fields_title = {{'uid':'User ID', 'Account':'Account', 'MaxSubmit':'Max Submit', 'MaxJobs':'Max Jobs', 'MaxNodes':'Max Nodes', 'MaxCPUs':'Max CPUs', 'MaxWall':'Max Wall Time', 'MaxCPUMins':'Max CPU min', 'alloc_nodes':'Alloc Nodes', 'alloc_cpus':'Alloc CPUs', 'alloc_gpus':'Alloc GPUs','alloc_mem':'Alloc Mem'}}
          var running_jobs   = {running_jobs}
          var pending_jobs   = {pending_jobs}
          var part_info      = {part_info}
          var job_history    = {job_history}
          var user_assoc     = {user_assoc}
          var array_het_jids = {array_het_jids}

          createList (user_assoc, u_fields_title, '#user_assoc')
          if (running_jobs.length >0) {{
             createTable (running_jobs, r_j_titles, 'run_job_table',  'running_jobs', undefined, job_type_dict);
          }}
          if (pending_jobs.length >0) {{
             createTable (pending_jobs, p_j_titles, 'pend_job_table',  'pending_jobs',undefined, job_type_dict);
          }}
          createTable (part_info,     part_titles,  'part_table',        'qos_part', undefined, part_type_dict)
          // add one extra line to category table headers
          $('#part_table thead').prepend('<tr><th colspan="2"></th><th colspan="3">User Lmt</th><th colspan="3">User Alloc</th><th colspan="3">User Avail</th><th colspan="3">Grp Lmt</th><th colspan="3">Grp Alloc</th><th colspan="3">Part. Total</th><th colspan="3">Part. Avail</th></tr>')
          if (array_het_jids) {{
             j_h_titles     = {{'JobIDRaw':'Job ID', 'JobID':'Job ID(Report)', 'JobName':'Name','AllocCPUS':'Alloc CPU','State':'State','ExitCode':'Exit Code','NodeList':'Alloc Node','Start':'Start','End':'End'}}
             jr_type_dict   = {{'JobIDRaw':'JobAndStep'}}
          }}
          createTable (job_history, j_h_titles,  'job_history_table', 'past_job', undefined, jr_type_dict)

          $("#running_jobs_len").text(running_jobs.length)
          $("#pending_jobs_len").text(pending_jobs.length)
          $("#part_len").text(part_info.length)
          $("#job_history_len").text(job_history.length)

          //$('.table_title + table').hide()
          $('.table_title').click(function(event) {{
             //$(this).children("i").toggleClass('hide')
             console.log("---click")
             $(this).toggleClass('table_title_collapse')
             $(this).next().toggleClass('hide')
          }});

          if (user_assoc['alloc_gpus'])
             $("#gpu_link").html ("<a href='userGPUGraph?user={uname}'>GPU Usage Graph, </a>")
      }});
    </script>
  </head>

  <body>
    <div class="layout">
      <div class="stickynav">
        <div class="stickynav__inner">
          <div class="stickynav__content">
            <div class="stickynav__logo">
              <a href="/" class="hero__title hero__title--crumb">Slurm Util</a>
            </div>
            <div class="stickynav__update">Updated: {update_time}</div>
          </div>
        </div>
      </div>
      <nav class="nav" id="navmenu"></nav>
      <section class="section">
        <div class="section__inner section__inner--fullwidth">
          <div class="section__div">
            <h3>
              {user} ({uname}):
              <small>
                <a href="userJobGraph?user={uname}">Usage Graph</a>,
                <span id="gpu_link"></span>
                <a href="user_fileReport?user={uname}&days=30">File Usage Report</a>
              </small>
            </h3>
            <p><i>Update time: {update_time}</i></p>
          </div>
          <div class="section__div">
            <div id="user_assoc"></div>
          </div>
        </div>
      </section>
      <section class="section">
        <div class="section__inner section__inner--fullwidth">
          <div class="section__div" id="qos_part">
            <h3 class="table_title">Total <span id="part_len"></span> Available Partitions</h3>
          </div>
        </div>
      </section>
      <section class="section">
        <div class="section__inner section__inner--fullwidth">
          <div class="section__div" id="running_jobs">
            <h3 class="table_title">Total <span id="running_jobs_len"></span> Running Jobs</h3>
          </div>
        </div>
      </section>
      <section class="section">
        <div class="section__inner section__inner--fullwidth">
          <div class="section__div" id="pending_jobs">
            <h3 class="table_title">Total <span id="pending_jobs_len"></span> Pending Jobs</h3>
          </div>
        </div>
      </section>
      <section class="section">
        <div class="section__inner section__inner--fullwidth">
          <div class="section__div" id="past_job">
            <h3 class="table_title">Total <span id="job_history_len"></span> Jobs of Last {day_cnt} Days of User</h3>
            <!-- <p>You can change the number of days by adding/changing the parameter "days" in the address such as http://scclin011:8126/userDetails?user=uname<span color="green">&days=7</span> -->
          </div>
        </div>
      </section>
    </div>
    <footer class="section section--footer">
      <div class="section__inner section__inner--footer">
        <a href="/" class="hero__title hero__title--footer">Slurm Util</a>
        <p class="hero__text hero__text--small">Updates every 10 minutes</p>
      </div>
    </footer>
  </body>
</html>
